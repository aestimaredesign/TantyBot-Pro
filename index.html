<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TantyBot-Pro - Construction Cost Estimator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f4f4f4;
    }
    #chatContainer {
      width: 400px;
      height: 500px;
      margin: 20px auto;
      border: 1px solid #ccc;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      background-color: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    #chatHeader {
      background-color: #2563eb;
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 1.2em;
      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
    }
    #chatContent {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      border-bottom: 1px solid #ccc;
    }
    #chatInputArea {
      padding: 10px;
      display: flex;
      gap: 5px;
    }
    #chatInput {
      flex: 1;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    #sendBtn {
      padding: 5px 10px;
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    #sendBtn:hover {
      background-color: #1d4ed8;
    }
  </style>
</head>
<body>
  <div id="chatContainer">
    <div id="chatHeader">TantyBot-Pro</div>
    <div id="chatContent">
      <p><strong>TantyBot:</strong> Hey! I’m TantyBot-Pro, your construction cost pro. What’s up? Toss me some project details whenever you’re ready!</p>
    </div>
    <div id="chatInputArea">
      <input type="text" id="chatInput" placeholder="Chat with TantyBot-Pro...">
      <button id="sendBtn">Send</button>
    </div>
  </div>
  <script>
    const chatContent = document.getElementById("chatContent");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    let projectHistory = { location: "", squareFootage: 0, materials: "Standard", trades: {} };

    // Mock Data Model
    const items = new Map([
      ["item_001", { item_id: "item_001", division: "Concrete", code: "CON01", name: "Concrete Mix", description: "Standard concrete", unit: "cu.m", assembly_ref: null, spec_refs: [] }],
      ["item_002", { item_id: "item_002", division: "Steel", code: "STL01", name: "Rebar", description: "Reinforcement steel", unit: "kg", assembly_ref: null, spec_refs: [] }],
    ]);
    const assemblies = new Map([
      ["assy_001", { assembly_id: "assy_001", name: "Foundation", notes: "Basic foundation build-up", components: [{ component_type: "material", ref_id: "item_001", qty_per_unit: 10, waste_factor: 0.05 }, { component_type: "labor", ref_id: "crew_001", qty_per_unit: 1 }] }],
    ]);
    const rates = new Map([
      ["rate_001", { rate_id: "rate_001", item_id: "item_001", region: "Global", base_cost: 100, currency: "USD", valid_from: "2025-01-01", valid_to: "2025-12-31" }],
      ["rate_002", { rate_id: "rate_002", item_id: "item_002", region: "Global", base_cost: 0.8, currency: "USD", valid_from: "2025-01-01", valid_to: "2025-12-31" }],
    ]);
    const crews = new Map([
      ["crew_001", { crew_id: "crew_001", trade: "Mason", composition: "2 workers", output_per_day: 50, unit: "sq.m", region: "Global", source: "Industry Avg", confidence: 0.9 }],
    ]);
    const markups = new Map([["global", { region: "global", overhead_pct: 10, profit_pct: 5, contingency_pct: 10, vat_pct: 12 }]]);

    sendBtn.addEventListener("click", sendMessage);
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    function sendMessage() {
      const message = chatInput.value.trim();
      if (message) {
        chatContent.innerHTML += `<p><strong>You:</strong> ${message}</p>`;
        let response = handleTantyBotResponse(message);
        chatContent.innerHTML += `<p><strong>TantyBot:</strong> ${response}</p>`;
        chatInput.value = "";
        chatContent.scrollTop = chatContent.scrollHeight;
      } else {
        console.log("No message to send—type something first!");
      }
    }

    function handleTantyBotResponse(message) {
      // Update project history casually
      if (message.toLowerCase().includes("location")) {
        projectHistory.location = message.split("location")[1].trim() || projectHistory.location;
      } else if (message.toLowerCase().includes("square footage")) {
        const footage = parseFloat(message.match(/\d+/));
        if (!isNaN(footage)) projectHistory.squareFootage = footage;
      } else if (message.toLowerCase().includes("material")) {
        projectHistory.materials = message.split("material")[1].trim() || projectHistory.materials;
      }

      // Retrieval & Reasoning with RAG-like lookup
      if (message.toLowerCase().includes("hey") || message.toLowerCase().includes("hi")) {
        return "Hey there! I’m TantyBot-Pro, your construction cost pro. Got a project? Drop details like location or size whenever!";
      } else if (message.toLowerCase().includes("estimate") || message.toLowerCase().includes("cost")) {
        if (!projectHistory.location && !projectHistory.squareFootage && !Object.keys(projectHistory.trades).length) {
          return "Nice, let’s talk costs! Throw me a location or square footage if you’ve got it—otherwise, I’ll give a rough guess. What’s the project?";
        }
        return generateCostEstimate();
      } else if (message.toLowerCase().includes("formula")) {
        return "Here’s the deal: Total Cost = (Quantity × Material Cost) + (Quantity × Labor Cost) + 15% Indirect + 10% Contingency. I handle the math, no guessing!";
      } else if (message.toLowerCase().includes("units")) {
        return "I’m metric by default—sq.m, cu.m, linear m. Want feet or yards? Just ask!";
      } else if (message.toLowerCase().includes("chart")) {
        return "Cool idea! Say yes, and I’ll mock up a cost chart!";
      } else if (message.toLowerCase().includes("update")) {
        return updateEstimate(message);
      } else if (message.toLowerCase().includes("price") || message.toLowerCase().includes("cost of")) {
        const item = message.split("of")[1]?.trim() || message.split("price")[1]?.trim();
        return getPriceFromCostDB(item);
      } else {
        return "Hey, I’m here for cost help! Try ‘location: Manila’, ‘square footage: 1000’, or ask about prices. What’s on your mind?";
      }
    }

    // Toolformer-style: Call Cost DB instead of hallucinating
    function getPriceFromCostDB(item) {
      const rate = [...rates.values()].find(r => items.has(r.item_id) && items.get(r.item_id).name.toLowerCase().includes(item.toLowerCase()));
      return rate ? `Price for ${items.get(rate.item_id).name} is $${rate.base_cost} ${rate.currency} in ${rate.region} (valid ${rate.valid_from} to ${rate.valid_to}). Need more?` : "Hmm, couldn’t find that in my Cost DB. Try ‘concrete’ or ‘rebar’!";
    }

    function generateCostEstimate() {
      let totalCost = 0;
      let estimate = "<h4>Cost Breakdown (Estimate)</h4><ul>";
      if (Object.keys(projectHistory.trades).length === 0) {
        totalCost = projectHistory.squareFootage * getBaseRateForSquareFootage();
      } else {
        for (let discipline in projectHistory.trades) {
          let discTotal = 0;
          estimate += `<li><strong>${discipline}:</strong><ul>`;
          projectHistory.trades[discipline].forEach((item, index) => {
            const rate = rates.get(`rate_${item.item_id.split("_")[1]}`) || { base_cost: 0 };
            const matCost = item.qty * rate.base_cost;
            const laborCost = item.qty * (crews.get("crew_001")?.output_per_day ? 50 / crews.get("crew_001").output_per_day * rate.base_cost : 0); // Mock labor
            const itemTotal = matCost + laborCost;
            discTotal += itemTotal;
            estimate += `<li>${index + 1}. ${items.get(item.item_id)?.name || item.item_id}: ${item.qty} ${item.unit} = $${fmt(itemTotal)}</li>`;
          });
          estimate += `<li>Total ${discipline}: $${fmt(discTotal)}</li></ul>`;
          totalCost += discTotal;
        }
      }
      const markup = markups.get("global");
      const indirectCost = totalCost * (markup.overhead_pct + markup.contingency_pct) / 100;
      const profit = totalCost * markup.profit_pct / 100;
      const vat = totalCost * markup.vat_pct / 100;
      totalCost += indirectCost + profit + vat;
      estimate += `<li><strong>Indirect + Contingency (${markup.overhead_pct + markup.contingency_pct}%):</strong> $${fmt(indirectCost)}</li>`;
      estimate += `<li><strong>Profit (${markup.profit_pct}%):</strong> $${fmt(profit)}</li>`;
      estimate += `<li><strong>VAT (${markup.vat_pct}%):</strong> $${fmt(vat)}</li>`;
      estimate += `<li><strong>Grand Total:</strong> $${fmt(totalCost)}</li></ul>`;
      estimate += `Notes: Based on ${projectHistory.materials} materials, ${projectHistory.location || 'assumed location'}, ${markup.region} markups. Add trades for detail!`;
      return estimate;
    }

    function updateEstimate(message) {
      if (message.toLowerCase().includes("premium")) projectHistory.materials = "Premium";
      return generateCostEstimate() + ` Updated with ${projectHistory.materials}—looking good?`;
    }

    function getBaseRateForSquareFootage() {
      return 100; // Placeholder rate per m²
    }

    function fmt(n, dec = 2) {
      return Number(n).toLocaleString(undefined, { minimumFractionDigits: dec, maximumFractionDigits: dec });
    }
  </script>
</body>
</html>
